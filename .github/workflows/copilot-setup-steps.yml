name: Copilot Setup Steps

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  setup-and-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: true

      # Install go dependencies
      - name: Install Go dependencies
        run: go mod download

      # Install golangci-lint
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | \
          sh -s -- -b $(go env GOPATH)/bin latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # Install Node.js for linters
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install npm packages required by .githooks/pre-commit
      # These are CRITICAL for validation to pass
      - name: Install Node.js linting tools
        run: npm install -g cspell markdownlint-cli2 @cspell/dict-da-dk prettier

      ## Run Go vet
      #- name: Run go vet
      #  run: go vet ./...

      ## Run golangci-lint
      #- name: Run golangci-lint
      #  run: golangci-lint run ./...

      ## Run Go tests
      #- name: Run Go tests
      #  run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      ## Upload coverage
      #- name: Upload coverage to Codecov
      #  uses: codecov/codecov-action@v4
      #  with:
      #    files: ./coverage.txt
      #    flags: unittests
      #    name: codecov-umbrella
      #    fail_ci_if_error: false

      ## Build the binary
      #- name: Build binary
      #  run: make build

      ## Test the binary
      #- name: Test binary help command
      #  run: ./utils --help

      # Configure git hooks path
      - name: Configure Git hooks
        run: git config core.hooksPath .githooks

      # Verify the setup by running the pre-commit hook
      - name: Test pre-commit hook
        run: .githooks/pre-commit
